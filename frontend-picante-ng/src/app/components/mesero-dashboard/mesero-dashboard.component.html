<div class="dashboard-wrapper min-vh-100 bg-light">
  <!-- Barra de NavegaciÃ³n -->
  <nav class="navbar navbar-dark bg-danger bg-gradient shadow-sm px-4 py-3 mb-4">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1 fw-bold">
        <i class="bi bi-shop me-2"></i> El Picante - Mesero
      </span>
      <div class="d-flex align-items-center text-white gap-2">
        <app-boton-actualizar 
          texto="Actualizar"
          textoTooltip="Refrescar estado de mesas"
          [cargando]="loadingTables"
          (actualizar)="actualizarMesas()">
        </app-boton-actualizar>
        <div class="me-3 text-end d-none d-sm-block">
          <small class="d-block opacity-75">SesiÃ³n de:</small>
          <span class="fw-bold">{{ currentUser?.username || 'Mesero' }}</span>
        </div>
        <div
          class="avatar bg-white text-danger fw-bold rounded-circle me-3 d-flex align-items-center justify-content-center shadow-sm"
          style="width: 40px; height: 40px;">
          {{ (currentUser?.username || 'M')[0].toUpperCase() }}
        </div>
        <button (click)="logout()" class="btn btn-outline-light btn-sm rounded-pill px-3 shadow-sm">
          <i class="bi bi-box-arrow-right me-1"></i> Salir
        </button>
      </div>
    </div>
  </nav>

  <div class="container-fluid px-4 pb-5">
    <!-- SECCIÃ“N SALÃ“N -->
    <div class="mb-5">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h4 mb-0 fw-bold border-start border-4 border-success ps-3">SALÃ“N</h2>
      </div>
      <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-4">
        <div *ngFor="let table of salonTables" class="col">
          <div (click)="selectTable(table)" class="card h-100 table-card border-0 shadow-sm" [ngClass]="{
                            'border-top border-4 border-secondary opacity-75': table.status === 'AVAILABLE',
                            'border-top border-4 border-warning': table.status === 'OCCUPIED' || table.status === 'READY_TO_KITCHEN',
                            'border-top border-4 border-primary': table.status === 'WAITING_KITCHEN' || table.status === 'PREPARING',
                            'border-top border-4 border-success animate-pulse': table.status === 'READY',
                            'border-top border-4 border-info': table.status === 'SERVING',
                            'border-top border-4 border-danger': table.status === 'WAITING_PAYMENT'
                         }">
            <div class="card-body p-3 text-center">
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold text-muted small">{{ table.name }}</span>
                <span class="small text-muted"><i class="bi bi-people"></i> {{ table.capacity }}</span>
              </div>

              <div class="status-icon py-2">
                <i class="bi h2" [ngClass]="{
                                    'bi-dash-circle text-muted': table.status === 'AVAILABLE',
                                    'bi-pencil-square text-warning': table.status === 'OCCUPIED',
                                    'bi-send text-warning': table.status === 'READY_TO_KITCHEN',
                                    'bi-clock-history text-primary': table.status === 'WAITING_KITCHEN',
                                    'bi-fire text-primary': table.status === 'PREPARING',
                                    'bi-bell-fill text-success': table.status === 'READY',
                                    'bi-check-circle-fill text-info': table.status === 'SERVING',
                                    'bi-cash-coin text-danger animate-bounce': table.status === 'WAITING_PAYMENT'
                                }"></i>
              </div>

              <span class="badge rounded-pill mt-2 w-100" [ngClass]="{
                                'bg-secondary': table.status === 'AVAILABLE',
                                'bg-warning text-dark': table.status === 'OCCUPIED' || table.status === 'READY_TO_KITCHEN',
                                'bg-primary': table.status === 'WAITING_KITCHEN' || table.status === 'PREPARING',
                                'bg-success': table.status === 'READY',
                                'bg-info': table.status === 'SERVING',
                                'bg-danger': table.status === 'WAITING_PAYMENT'
                            }">
                {{ table.status === 'READY' ? 'Â¡LISTO!' : (table.status === 'SERVING' ? 'SIRVIENDO' : (table.status ===
                'WAITING_PAYMENT' ? 'POR PAGAR' : table.status)) }}
              </span>

              <app-timer *ngIf="table.occupiedAt" [startTime]="table.occupiedAt" [warningMinutes]="20"
                [dangerMinutes]="30" class="mt-2 small"></app-timer>

              <div class="mt-2" *ngIf="table.status === 'WAITING_PAYMENT' && isAdmin()">
                <button (click)="confirmarCobro(table)" class="btn btn-sm btn-danger rounded-pill px-3">
                  <i class="bi bi-cash-coin me-1"></i> Cobrar
                </button>
              </div>

              <div class="mt-2" *ngIf="table.status === 'WAITING_PAYMENT' && !isAdmin()">
                <button (click)="mostrarMensajeCobro()" class="btn btn-sm btn-danger rounded-pill px-3" disabled>
                  <i class="bi bi-cash-coin me-1"></i> Cobrar
                </button>
              </div>

              <div class="mt-2" *ngIf="table.status === 'OCCUPIED'">
                <button (click)="desocuparMesa(table)" class="btn btn-sm btn-warning rounded-pill px-3">
                  <i class="bi bi-arrow-clockwise me-1"></i> Desocupar
                </button>
              </div>

              <!-- BotÃ³n Cancelar Pedido - aparece cuando aÃºn no empieza preparaciÃ³n -->
              <div class="mt-2 d-flex gap-2 justify-content-center flex-wrap" 
                *ngIf="table.status === 'OCCUPIED' || table.status === 'READY_TO_KITCHEN' || table.status === 'WAITING_KITCHEN'">
                <button (click)="cancelarPedido(table)" class="btn btn-sm btn-outline-danger rounded-pill px-3">
                  <i class="bi bi-x-circle me-1"></i> Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECCIÃ“N PATIO -->
    <div class="mb-5">
      <div class="d-flex align-items-center mb-3">
        <h2 class="h4 mb-0 fw-bold border-start border-4 border-primary ps-3">PATIO</h2>
      </div>
      <div class="row row-cols-2 row-cols-md-3 row-cols-lg-5 g-4">
        <div *ngFor="let table of patioTables" class="col">
          <div (click)="selectTable(table)" class="card h-100 table-card border-0 shadow-sm" [ngClass]="{
                            'border-top border-4 border-success': table.status === 'READY',
                            'border-top border-4 border-secondary': table.status === 'AVAILABLE',
                            'border-top border-4 border-danger': table.status === 'WAITING_PAYMENT'}">
            <div class="card-body p-3 text-center">
              <div class="d-flex justify-content-between mb-2">
                <span class="fw-bold text-muted small">{{ table.name }}</span>
                <span class="small text-muted"><i class="bi bi-people"></i> {{ table.capacity }}</span>
              </div>
              <span class="badge rounded-pill mb-2" [ngClass]="{
                                'bg-secondary': table.status === 'AVAILABLE',
                                'bg-danger': table.status === 'WAITING_PAYMENT',
                                'bg-warning': table.status !== 'AVAILABLE' && table.status !== 'WAITING_PAYMENT'
                            }">{{ table.status }}</span>
              <app-timer *ngIf="table.occupiedAt" [startTime]="table.occupiedAt" [warningMinutes]="20"
                [dangerMinutes]="30" class="small"></app-timer>
              <div class="mt-2" *ngIf="table.status === 'WAITING_PAYMENT' && isAdmin()">
                <button (click)="confirmarCobro(table)" class="btn btn-sm btn-danger rounded-pill px-3">
                  <i class="bi bi-cash-coin me-1"></i> Cobrar
                </button>
              </div>
              <div class="mt-2" *ngIf="table.status === 'WAITING_PAYMENT' && !isAdmin()">
                <button (click)="mostrarMensajeCobro()" class="btn btn-sm btn-danger rounded-pill px-3" disabled>
                  <i class="bi bi-cash-coin me-1"></i> Cobrar
                </button>
              </div>
              <!-- BotÃ³n Cancelar Pedido - aparece cuando aÃºn no empieza preparaciÃ³n -->
              <div class="mt-2" 
                *ngIf="table.status === 'OCCUPIED' || table.status === 'READY_TO_KITCHEN' || table.status === 'WAITING_KITCHEN'">
                <button (click)="cancelarPedido(table)" class="btn btn-sm btn-outline-danger rounded-pill px-3 w-100">
                  <i class="bi bi-x-circle me-1"></i> Cancelar
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE PRODUCTOS (REUTILIZABLE) -->
  <div *ngIf="menuModalOpen" class="modal-overlay" (click)="closeProductModal()">
    <div class="modal-content-custom" (click)="$event.stopPropagation()">
      <div class="modal-header-custom">
        <h3>ðŸ›’ Selecciona platos para: {{ selectedTable?.name || 'Mesa' }}</h3>
        <button class="btn-close-custom" (click)="closeProductModal()">âœ•</button>
      </div>

      <div class="modal-body-custom">
        <!-- Campo de bÃºsqueda -->
        <div class="search-box mb-3">
          <input 
            type="text" 
            class="form-control" 
            placeholder="ðŸ” Buscar platos..." 
            [(ngModel)]="searchText"
            (input)="onSearchChange()">
        </div>

        <!-- Filtro por categorÃ­a -->
        <div class="category-filter mb-3">
          <button 
            *ngFor="let cat of categories" 
            (click)="selectCategory(cat)"
            class="btn btn-sm me-2 mb-2"
            [class.btn-primary]="selectedCategory === cat"
            [class.btn-outline-secondary]="selectedCategory !== cat">
            {{ cat }}
          </button>
        </div>

        <!-- Lista de productos -->
        <div class="products-list">
          <div *ngIf="getFilteredProducts().length === 0" class="text-center text-muted py-5">
            <p>No hay productos disponibles en esta categorÃ­a</p>
          </div>
          <div *ngFor="let product of getFilteredProducts()" class="product-item">
            <div class="product-info">
              <h5>{{ product.name }}</h5>
              <p class="text-muted small mb-1">{{ product.description }}</p>
              <p class="text-success fw-bold mb-0">S/. {{ product.price | number:'1.2-2' }}</p>
            </div>
            <div class="product-actions">
              <button class="btn btn-sm btn-danger" (click)="removeProduct(product)" [disabled]="getProductQuantity(product.id) === 0">
                âˆ’
              </button>
              <span class="quantity-badge">{{ getProductQuantity(product.id) }}</span>
              <button class="btn btn-sm btn-success" (click)="addProduct(product)">
                +
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer-custom">
        <div class="total-section">
          <h4>Total de platos: <span class="badge bg-primary">{{ getTotalQuantity() }}</span></h4>
        </div>
        <div class="action-buttons">
          <button class="btn btn-secondary me-2" (click)="closeProductModal()">Cancelar</button>
          <button class="btn btn-success" (click)="confirmOrder()" [disabled]="getTotalQuantity() === 0">
            âœ… Confirmar Pedido
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL DE PAGO MEJORADO -->
  <app-payment-modal
    [isOpen]="showPaymentModal"
    [table]="selectedTableForPayment"
    [order]="currentOrderForPayment"
    [mozoTime]="mozoTime"
    [kitchenTime]="kitchenTime"
    (close)="onPaymentClose()"
    (confirm)="onPaymentConfirm($event)">
  </app-payment-modal>

  <!-- COMPROBANTE/RECIBO -->
  <app-receipt
    [isOpen]="showReceipt"
    [table]="selectedTableForPayment"
    [order]="currentOrderForPayment"
    [paymentData]="lastPaymentData"
    (close)="onReceiptClose()"
    (print)="printReceipt()">
  </app-receipt>
</div>